# udev

[[Linux]]システムにおけるデバイス管理を行うユーザースペースのデバイスマネージャー。カーネルが検出したハードウェアデバイスに対して、デバイスノードの作成、シンボリックリンクの作成、権限設定などを動的に行う。

## 概要

udevは、Linuxカーネルのsysfsファイルシステムとnetlinkソケットを使用して、デバイスの追加・削除イベントを監視し、適切なデバイスファイルを`/dev`ディレクトリに作成・削除する。従来の静的なデバイスファイル管理方式と異なり、実際に接続されているデバイスのみを管理する動的なアプローチを採用している。

## 主な機能

- **デバイスノードの動的作成・削除**: ハードウェアの接続・切断に応じて`/dev`下のデバイスファイルを自動管理
- **デバイス命名の一貫性**: 予測可能で一貫したデバイス名の提供
- **権限とアクセス制御**: デバイスファイルの所有者、グループ、権限の設定
- **シンボリックリンクの作成**: デバイスへの分かりやすいエイリアスの提供
- **カスタムアクションの実行**: デバイスイベントに応じた任意のスクリプトやコマンドの実行

## アーキテクチャ

### カーネル空間との連携
- **sysfs**: `/sys`ファイルシステムを通じてデバイス情報を取得
- **netlink**: カーネルからのデバイスイベントをnetlinkソケット経由で受信
- **uevent**: カーネルが生成するデバイスイベントメッセージ

### 主要コンポーネント
- **udevd**: udevデーモン（systemd-udevd）
- **udevadm**: udev管理・デバッグツール
- **libudev**: udev機能にアクセスするためのライブラリ

## ルール（Rules）

udevの動作は、`/etc/udev/rules.d/`および`/lib/udev/rules.d/`に配置されたルールファイルによって制御される。

### ルールファイルの構造
```
[数字]-[名前].rules
```
- 数字による優先順位（小さい数字が先に処理）
- 一般的な範囲：
  - 10-19: カーネルデバイス
  - 20-29: グループ管理
  - 40-49: デバイス命名
  - 50-59: アクセス権限
  - 60-69: アプリケーション固有

### ルール記述例
```
# USBストレージデバイスの自動マウント
SUBSYSTEM=="block", ATTRS{idVendor}=="0781", ATTRS{idProduct}=="5567", SYMLINK+="sandisk"

# ネットワークインターフェースの固定命名
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="aa:bb:cc:dd:ee:ff", NAME="eth0"
```

## 重要なディレクトリとファイル

### 設定ディレクトリ
- `/etc/udev/rules.d/`: カスタムルールファイル
- `/lib/udev/rules.d/`: システム標準ルールファイル
- `/etc/udev/udev.conf`: udev設定ファイル

### 実行時ディレクトリ
- `/run/udev/`: 実行時データ
- `/dev/`: デバイスノード作成場所
- `/sys/`: カーネルデバイス情報

## udevadmコマンド

### 主要サブコマンド
- `info`: デバイス情報の表示
- `trigger`: ueventの手動発生
- `settle`: 保留中のイベントの完了待機
- `control`: udevdの制御
- `monitor`: デバイスイベントの監視
- `test`: ルールのテスト実行

### 使用例
```bash
# デバイス情報の確認
udevadm info --query=all --name=/dev/sda1

# ネットワークデバイスの再初期化
udevadm trigger --subsystem-match=net

# イベント監視
udevadm monitor --environment --udev
```

## systemdとの統合

現代のLinuxディストリビューションでは、udevはsystemdの一部として統合されている。

### 関連サービス
- `systemd-udevd.service`: udevデーモン
- `systemd-udev-trigger.service`: 起動時のデバイス検出
- `systemd-udev-settle.service`: デバイス初期化の完了待機

## トラブルシューティング

### よくある問題
- **デバイスノードが作成されない**: ルールの記述ミスやカーネルドライバの問題
- **権限が正しく設定されない**: グループ設定やACLの競合
- **起動時のデバイス認識遅延**: settle服務の依存関係問題

### デバッグ手法
- ログ確認: `journalctl -u systemd-udevd`
- ルールテスト: `udevadm test /sys/path/to/device`
- イベント監視: `udevadm monitor`

## セキュリティ考慮事項

- ルールファイルの権限管理（root所有、644権限推奨）
- デバイスアクセス制御の適切な設定
- 外部スクリプト実行時のセキュリティリスク
- 予期しないデバイスの自動処理に対する保護